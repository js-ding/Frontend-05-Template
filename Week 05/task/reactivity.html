<script>
  let callbacks = new Map();
  let reactivities = new Map();
  let usedReactivities = [];

  let animate = {
    name: "å¤§ç°ğŸ±",
    gender: "æ¯",
    age: 18,
    child: {
        name: 'å°ç°ğŸ±',
        gender: 'æ¯',
        age: 1,
    }
  };

  /**
   *
   * @param {*} callback
   * ç›‘å¬ä»£ç†å¯¹è±¡ä¸Šçš„å±æ€§ï¼Ÿ
   * é¢„æœŸï¼šä¼ å…¥ä¸€ä¸ªå‡½æ•°åœ¨å¯¹åº”äº‹ä»¶æ‰§è¡Œæ—¶æ‰è°ƒç”¨callback
   * æ— æ³•çŸ¥é“ä¸€ä¸ªå‡½æ•°é‡Œé¢å¼•ç”¨é‚£äº›å˜é‡
   */
  function effect(callback) {
    //   callbacks.push(callback);
    usedReactivities = [];
    callback();
    console.log('usedReactivities', usedReactivities);

    for (const reactivity of usedReactivities) {
        // reactivity: [reactiveObjKey, reactiveObj]
        // å®‰å…¨å¤„ç†
        if (!callbacks.has(reactivity[0])) {
            callbacks.set(reactivity[0], new Map());
        }
        if (!callbacks.get(reactivity[0]).has[reactivity[1]]) {
            callbacks.get(reactivity[0]).set(reactivity[1], []);
        }

        callbacks.get(reactivity[0]).get(reactivity[1]).push(callback);
        // console.log('callbacks', callbacks);
    }
  }

  /**
   *
   * @param {*} obj
   * ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå¾—åˆ°ä¸€ä¸ªè¿™ä¸ªå¯¹è±¡ä»£ç†å¯¹è±¡
   */
  function reactive(obj) {
    if (reactivities.has(obj)) {
        return reactivities.get(obj);
    }

    let proxy = new Proxy(obj, {
      get(obj, key, receiver) {
        // è°ƒç”¨å¯¹è±¡é‡Œé‚£äº›å±æ€§å‘¢ï¼Ÿåœ¨è¿™é‡Œå¯ä»¥å¤„ç†
        // ç–‘é—®ï¼šè¿™é‡Œpushæ•°ç»„ï¼Œè€å¸ˆä»£ç ç¬¬ä¸€ä½æ”¾å…¥å¯¹è±¡ï¼Œæˆ‘è¿™é‡Œæ”¾å…¥é”®ï¼Œæœ€åè¾¾åˆ°æ•ˆæœä¸€è‡´ï¼Œè¿™é‡Œæœ‰ä»€ä¹ˆè®²ç©¶å—ï¼Ÿ
        usedReactivities.push([key, obj]);
        if (typeof obj[key] === 'object') {
            return reactive(obj[key]);
        }
        return obj[key];
      },
      set(obj, key, value, receiver) {
        obj[key] = value;
        if (callbacks.get(key) && callbacks.get(key).get(obj)) {
            for (const callback of callbacks.get(key).get(obj)) {
                callback();
            }
        }
        return obj[key];
      },
    });

    reactivities.set(obj, proxy);
    return proxy;
  }

  const cat = reactive(animate);
  effect(() => console.log('è§¦å‘effect', cat.child.age));
</script>
